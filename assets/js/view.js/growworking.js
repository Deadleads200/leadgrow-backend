$(document).ready(function () {

    const modal = new bootstrap.Modal(document.getElementById("growWorkingModal"));

    // Reset table if exists
    if ($.fn.DataTable.isDataTable("#growWorking_config")) {
        $("#growWorking_config").DataTable().clear().destroy();
    }

    const table = $("#growWorking_config").DataTable({
        responsive: true,
        autoWidth: false,
        searching: false,
        ajax: { url: "/growworkingjson", dataSrc: "data" },
        columns: [
            {
                data: "title",
                render: (title) => title || "<span class='text-muted'>N/A</span>"
            },
            {
                data: "shortDescription",
                render: (desc) => {
                    if (!desc) return "<span class='text-muted'>N/A</span>";
                    const shortDesc = desc.length > 50 ? desc.substring(0, 50) + "..." : desc;
                    return `<span title="${desc}">${shortDesc}</span>`;
                }
            },
            {
                data: null,
                className: "text-center",
                render: (row) => `
            <div class="dropdown dropstart">
              <button class="btn btn-sm btn-light rounded-circle" data-bs-toggle="dropdown">
                <i class="fa-solid fa-ellipsis-vertical"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end shadow">
                <li>
                  <button class="dropdown-item edit-btn" data-id="${row._id}">
                    <i class="fa-solid fa-pen-to-square me-2 text-primary"></i>Edit
                  </button>
                </li>
                <li>
                  <button class="dropdown-item delete-btn" data-id="${row._id}">
                    <i class="fa-solid fa-trash me-2 text-danger"></i>Delete
                  </button>
                </li>
              </ul>
            </div>`
            }
        ],
        order: [],
    });

    // ========== ADD BUTTON ==========
    $("#addGrowWorkingBtn").click(() => {
        $("#growWorkingForm")[0].reset();
        $("#growWorkingId").val("");
        $("#growWorkingModalLabel").text("Add Working Step");
        modal.show();
    });

       $("#generateGrowAI").click(function () {
        const title = $("#growWorkingTitle").val().trim();

        if (!title) {
            Swal.fire("Error", "Please enter Title first", "warning");
            return;
        }

        Swal.fire({
            title: "Generating...",
            text: "AI is writing description",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        $.ajax({
            url: "/generateDescription", // Backend same as blog temporary AI
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ name: title, prompt: 'Generate exactly 15 words in one sentence. No punctuation at the beginning or end. No extra text.' }),
            success: (res) => {
                Swal.close();
                if (!res.success) {
                    Swal.fire("Error", res.message, "error");
                    return;
                }

                const fullDesc = res.description;
                const shortDesc = fullDesc.split(" ").slice(0, 35).join(" ") + "...";

                $("#growWorkingDesc").val(shortDesc);

                Swal.fire("Success", "Description generated by AI", "success");
            },
            error: () => {
                Swal.close();
                Swal.fire("Error", "AI generation failed", "error");
            }
        });
    });
    // ========== SUBMIT FORM ==========
    $("#growWorkingForm").submit(function (e) {
        e.preventDefault();

        const id = $("#growWorkingId").val();
        
        // Data payload
        const payload = {
            title: $("#growWorkingTitle").val(),
            shortDescription: $("#growWorkingDesc").val()
        };

        if (id) payload.id = id;

        $.ajax({
            url: "/growworkingsave",
            type: "POST",
            data: payload,
            success: (res) => {
                if (res.success) {
                    Swal.fire("Success", res.message, "success");
                    modal.hide();
                    $("#growWorkingForm")[0].reset();
                    table.ajax.reload(null, false);
                } else {
                    Swal.fire("Error", res.message, "error");
                }
            },
            error: (xhr) => {
                const res = xhr.responseJSON;
                const msg = res?.message || "Something went wrong!";
                Swal.fire("Error", msg, "error");
            },
        });
    });

    // ========== EDIT BUTTON ==========
    $("#growWorking_config").on("click", ".edit-btn", function () {
        const row = table.row($(this).closest("tr")).data();
        if (!row) return Swal.fire("Error", "Data not found", "error");

        $("#growWorkingForm")[0].reset();
        $("#growWorkingId").val(row._id);
        $("#growWorkingTitle").val(row.title);
        $("#growWorkingDesc").val(row.shortDescription);

        $("#growWorkingModalLabel").text("Edit Working Step");
        modal.show();
    });

    // ========== DELETE BUTTON ==========
    $("#growWorking_config").on("click", ".delete-btn", function () {
        const id = $(this).data("id");

        Swal.fire({
            title: "Delete this Item?",
            text: "This action cannot be undone!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, Delete",
            cancelButtonText: "Cancel",
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/growworkingdelete/${id}`,
                    type: "DELETE",
                    success: (res) => {
                        if (res.success) {
                            Swal.fire("Done!", res.message, "success");
                            table.ajax.reload(null, false);
                        } else {
                            Swal.fire("Error", res.message, "error");
                        }
                    },
                    error: () => Swal.fire("Error", "Failed to delete", "error"),
                });
            }
        });
    });

});