$(document).ready(function () {

    const modal = new bootstrap.Modal(document.getElementById("growToolModal"));

    // Reset table if exists
    if ($.fn.DataTable.isDataTable("#growTool_config")) {
        $("#growTool_config").DataTable().clear().destroy();
    }

    const table = $("#growTool_config").DataTable({
        responsive: true,
        autoWidth: false,
        searching: false,
        ajax: { url: "/growtooljson", dataSrc: "data" },
        columns: [
            {
                data: "title",
                render: (title) => title || "<span class='text-muted'>N/A</span>"
            },
            {
                data: "description",
                render: (desc) => {
                    if (!desc) return "<span class='text-muted'>N/A</span>";
                    const shortDesc = desc.length > 50 ? desc.substring(0, 50) + "..." : desc;
                    return `<span title="${desc}">${shortDesc}</span>`;
                }
            },
            {
                data: "image",
                render: (img) =>
                    img
                        ? `<img src="${img}" width="80" height="50" class="rounded border" style="object-fit: cover;">`
                        : `<span class="text-muted">No Image</span>`
            },
            {
                data: null,
                className: "text-center",
                render: (row) => `
            <div class="dropdown dropstart">
              <button class="btn btn-sm btn-light rounded-circle" data-bs-toggle="dropdown">
                <i class="fa-solid fa-ellipsis-vertical"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end shadow">
                <li>
                  <button class="dropdown-item edit-btn" data-id="${row._id}">
                    <i class="fa-solid fa-pen-to-square me-2 text-primary"></i>Edit
                  </button>
                </li>
                <li>
                  <button class="dropdown-item delete-btn" data-id="${row._id}">
                    <i class="fa-solid fa-trash me-2 text-danger"></i>Delete
                  </button>
                </li>
              </ul>
            </div>`
            }
        ],
        order: [],
    });

    // ========== ADD BUTTON ==========
    $("#addGrowToolBtn").click(() => {
        $("#growToolForm")[0].reset();
        $("#growToolId").val("");
        $("#previewImage").attr("src", "").hide();
        $("#growToolModalLabel").text("Add Grow Tool");
        modal.show();
    });

    // ========== IMAGE PREVIEW ==========
    $("#growToolImage").change(function () {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) =>
                $("#previewImage").attr("src", e.target.result).show();
            reader.readAsDataURL(file);
        } else {
            $("#previewImage").attr("src", "").hide();
        }
    });

        $("#generateGrowToolAI").click(function () {
        const title = $("#growToolTitle").val().trim();

        if (!title) {
            Swal.fire("Error", "Please enter Title first", "warning");
            return;
        }

        Swal.fire({
            title: "Generating...",
            text: "AI is writing description",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        $.ajax({
            url: "/generateDescription", // backend same as blog temporary AI
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ name: title, prompt: 'Write exactly 3 concise sentences (max 40 words total) describing worldwide reach and global lead generation benefits.' }),
            success: (res) => {
                Swal.close();
                if (!res.success) {
                    Swal.fire("Error", res.message, "error");
                    return;
                }

                const fullDesc = res.description;
                $("#growToolDescription").val(fullDesc);

                Swal.fire("Success", "Description generated by AI", "success");
            },
            error: () => {
                Swal.close();
                Swal.fire("Error", "AI generation failed", "error");
            }
        });
    });
    // ========== SUBMIT FORM ==========
    $("#growToolForm").submit(function (e) {
        e.preventDefault();

        const formData = new FormData();
        const id = $("#growToolId").val();

        formData.append("title", $("#growToolTitle").val());
        formData.append("description", $("#growToolDescription").val());

        if (id) formData.append("id", id);

        // Append file
        const imageFile = $("#growToolImage")[0].files[0];
        if (imageFile) {
            formData.append("image", imageFile); // 'image' matches the name in multer
        }

        $.ajax({
            url: "/growtoolsave",
            type: "POST",
            data: formData,
            contentType: false, // Essential for file upload
            processData: false, // Essential for file upload
            success: (res) => {
                if (res.success) {
                    Swal.fire("Success", res.message, "success");
                    modal.hide();
                    $("#growToolForm")[0].reset();
                    $("#previewImage").hide();
                    table.ajax.reload(null, false);
                } else {
                    Swal.fire("Error", res.message, "error");
                }
            },
            error: (xhr) => {
                const res = xhr.responseJSON;
                const msg = res?.message || "Something went wrong!";
                Swal.fire("Error", msg, "error");
            },
        });
    });

    // ========== EDIT BUTTON ==========
    $("#growTool_config").on("click", ".edit-btn", function () {
        const row = table.row($(this).closest("tr")).data();
        if (!row) return Swal.fire("Error", "Data not found", "error");

        $("#growToolForm")[0].reset();
        $("#previewImage").hide();

        $("#growToolId").val(row._id);
        $("#growToolTitle").val(row.title);
        $("#growToolDescription").val(row.description);

        if (row.image) {
            $("#previewImage").attr("src", row.image).show();
        }

        $("#growToolModalLabel").text("Edit Grow Tool");
        modal.show();
    });

    // ========== DELETE BUTTON ==========
    $("#growTool_config").on("click", ".delete-btn", function () {
        const id = $(this).data("id");

        Swal.fire({
            title: "Delete this Tool?",
            text: "This action cannot be undone!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, Delete",
            cancelButtonText: "Cancel",
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/growtooldelete/${id}`,
                    type: "DELETE",
                    success: (res) => {
                        if (res.success) {
                            Swal.fire("Done!", res.message, "success");
                            table.ajax.reload(null, false);
                        } else {
                            Swal.fire("Error", res.message, "error");
                        }
                    },
                    error: () => Swal.fire("Error", "Failed to delete", "error"),
                });
            }
        });
    });

});