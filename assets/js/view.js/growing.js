$(document).ready(function () {

    const modal = new bootstrap.Modal(document.getElementById("growingModal"));

    if ($.fn.DataTable.isDataTable("#growing_config")) {
        $("#growing_config").DataTable().clear().destroy();
    }

    const table = $("#growing_config").DataTable({
        responsive: true,
        autoWidth: false,
        searching: false,
        ajax: { url: "/growingjson", dataSrc: "data" },
        columns: [
            {
                data: "label",
                render: (data) => data || "<span class='text-muted'>N/A</span>"
            },
            {
                data: "description",
                render: (desc) => {
                    if (!desc) return "<span class='text-muted'>N/A</span>";
                    const shortDesc = desc.length > 50 ? desc.substring(0, 50) + "..." : desc;
                    return `<span title="${desc}">${shortDesc}</span>`;
                }
            },
            {
                data: "count",
                render: (count) => `<span class="badge bg-primary fs-2">${count}</span>`
            },
            {
                data: null,
                className: "text-center",
                render: (row) => `
            <div class="dropdown dropstart">
              <button class="btn btn-sm btn-light rounded-circle" data-bs-toggle="dropdown">
                <i class="fa-solid fa-ellipsis-vertical"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end shadow">
                <li>
                  <button class="dropdown-item edit-btn" data-id="${row._id}">
                    <i class="fa-solid fa-pen-to-square me-2 text-primary"></i>Edit
                  </button>
                </li>
                <li>
                  <button class="dropdown-item delete-btn" data-id="${row._id}">
                    <i class="fa-solid fa-trash me-2 text-danger"></i>Delete
                  </button>
                </li>
              </ul>
            </div>`
            }
        ],
        order: [],
    });

    $("#addGrowingBtn").click(() => {
        $("#growingForm")[0].reset();
        $("#growingId").val("");
        $("#growingModalLabel").text("Add Growing Stat");
        modal.show();
    });

        $("#generateAIGrowing").click(() => {
        const label = $("#growingLabel").val().trim();

        if (!label) {
            Swal.fire("Error", "Please enter Label first", "warning");
            return;
        }

        Swal.fire({
            title: "Generating...",
            text: "AI is writing description",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        $.ajax({
            url: "/generateDescription", // POST API (temporary AI)
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ name: label , prompt: 'Generate exactly 4 to 7 words only. Focus on high customer satisfaction. Do not add punctuation.'}),
            success: (res) => {
                Swal.close();
                if (!res.success) return Swal.fire("Error", res.message, "error");

                const fullDesc = res.description;
                const shortDesc = fullDesc.split(" ").slice(0, 35).join(" ") + "...";

                $("#growingDescription").val(shortDesc);

                Swal.fire("Success", "Description generated by AI", "success");
            },
            error: () => {
                Swal.close();
                Swal.fire("Error", "AI generation failed", "error");
            }
        });
    });

    $("#growingForm").submit(function (e) {
        e.preventDefault();

        const id = $("#growingId").val();
        const payload = {
            label: $("#growingLabel").val(),
            description: $("#growingDescription").val(),
            count: $("#growingCount").val()
        };

        if (id) payload.id = id;

        $.ajax({
            url: "/growingsave",
            type: "POST",
            data: payload,
            success: (res) => {
                if (res.success) {
                    Swal.fire("Success", res.message, "success");
                    modal.hide();
                    $("#growingForm")[0].reset();
                    table.ajax.reload(null, false);
                } else {
                    Swal.fire("Error", res.message, "error");
                }
            },
            error: (xhr) => {
                const res = xhr.responseJSON;
                const msg = res?.message || "Something went wrong!";
                Swal.fire("Error", msg, "error");
            },
        });
    });

    $("#growing_config").on("click", ".edit-btn", function () {
        const row = table.row($(this).closest("tr")).data();
        if (!row) return Swal.fire("Error", "Data not found", "error");

        $("#growingForm")[0].reset();
        $("#growingId").val(row._id);
        $("#growingLabel").val(row.label);
        $("#growingDescription").val(row.description);
        $("#growingCount").val(row.count);

        $("#growingModalLabel").text("Edit Growing Stat");
        modal.show();
    });

    $("#growing_config").on("click", ".delete-btn", function () {
        const id = $(this).data("id");

        Swal.fire({
            title: "Delete this Stat?",
            text: "This action cannot be undone!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, Delete",
            cancelButtonText: "Cancel",
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/growingdelete/${id}`,
                    type: "DELETE",
                    success: (res) => {
                        if (res.success) {
                            Swal.fire("Done!", res.message, "success");
                            table.ajax.reload(null, false);
                        } else {
                            Swal.fire("Error", res.message, "error");
                        }
                    },
                    error: () => Swal.fire("Error", "Failed to delete", "error"),
                });
            }
        });
    });

});