document.addEventListener("DOMContentLoaded", () => {

  // Load SEO when tab opened
  document.querySelectorAll('.nav-link[data-type]').forEach(tab => {
    tab.addEventListener('shown.bs.tab', e => {
      const type = e.target.getAttribute('data-type');
      loadSeo(type);
    });
  });

  // First load (home)
  loadSeo("home");

  

  // Submit handler (UPDATE only)
  document.querySelectorAll('.seoForm').forEach(form => {
    form.addEventListener('submit', async e => {
      e.preventDefault();

      const formData = new FormData(form);
      const payload = Object.fromEntries(formData.entries());

      const res = await fetch('/seo/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      Swal.fire(data.message || "SEO Updated");
    });
  });
   // ========== GENERATE AI FOR META FIELDS ==========
 document.querySelectorAll('.seoForm').forEach(form => {
    const generateBtn = form.querySelector('.generateSEO');
    generateBtn.addEventListener('click', async () => {
      const type = form.getAttribute('data-type');
      console.log(type);
      
      if (!type) return Swal.fire("Error", "Page type not defined", "error");

      Swal.fire({
        title: "Generating...",
        text: "AI is writing meta data",
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      try {
        const response = await fetch("/generateMetaAll", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ page: type }) // page type
        });

        const data = await response.json();
        Swal.close();

        if (!data.success) {
          Swal.fire("Error", data.message || "AI generation failed", "error");
          return;
        }

        // Fill fields
        form.querySelector('[name="metaTitle"]').value = data.metaTitle || "";
        form.querySelector('[name="metaKeywords"]').value = data.metaKeywords || "";
        form.querySelector('[name="metaDescription"]').value = data.metaDescription || "";

        Swal.fire("Success", "Meta fields generated by AI", "success");

      } catch (err) {
        Swal.close();
        Swal.fire("Error", "AI generation failed", "error");
      }
    });
  });
   
});





// Load SEO data from DB
async function loadSeo(type) {
  const res = await fetch(`/seo/${type}`);
  const data = await res.json();

  const form = document.querySelector(`.seoForm[data-type="${type}"]`);
  if (!form) return;

  form.metaTitle.value = data?.metaTitle || "";
  form.metaKeywords.value = data?.metaKeywords || "";
  form.metaDescription.value = data?.metaDescription || "";
}
