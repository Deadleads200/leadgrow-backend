$(document).ready(function () {

  const modal = new bootstrap.Modal(document.getElementById("faqModal"));

  // Reset old datatable
  if ($.fn.DataTable.isDataTable("#zero_config")) {
    $("#zero_config").DataTable().clear().destroy();
  }

  // ========== DATATABLE ==========
  const table = $("#zero_config").DataTable({
    responsive: true,  
    autoWidth: false, 
    ajax: { url: "/faqjson", dataSrc: "data" },
    columns: [
      { data: "question" },
      {
        data: null,
        className: "text-center",
        render: (row) => `
          <div class="dropdown dropstart">
            <button class="btn btn-sm btn-light rounded-circle" data-bs-toggle="dropdown">
              <i class="fa-solid fa-ellipsis-vertical"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow">
              <li>
                <button class="dropdown-item edit-btn" data-id="${row._id}">
                  <i class="fa-solid fa-pen-to-square me-2 text-primary"></i>Edit
                </button>
              </li>
              <li>
                <button class="dropdown-item delete-btn" data-id="${row._id}">
                  <i class="fa-solid fa-trash me-2 text-danger"></i>Delete
                </button>
              </li>
            </ul>
          </div>`
      }
    ],
     order: [], 
  });

  // ========== ADD FAQ BUTTON ==========
  $("#addFaqBtn").click(() => {
    $("#faqForm")[0].reset();
    $("#faqId").val("");
    $("#faqModalLabel").text("Add FAQ");
    modal.show();
  });

    $("#generateFaqAI").click(function () {
    const question = $("#question").val().trim();

    if (!question) {
      Swal.fire("Error", "Please enter Question first", "warning");
      return;
    }

    Swal.fire({
      title: "Generating...",
      text: "AI is writing answer",
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    $.ajax({
      url: "/generateDescription", // backend AI API endpoint
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify({ name: question ,prompt:'Answer in only 2 concise sentences (max 20 words total). No examples, no extra details.'}),
      success: (res) => {
        Swal.close();
        if (!res.success) {
          Swal.fire("Error", res.message, "error");
          return;
        }

        const fullAnswer = res.description;
        $("#answer").val(fullAnswer);

        Swal.fire("Success", "Answer generated by AI", "success");
      },
      error: () => {
        Swal.close();
        Swal.fire("Error", "AI generation failed", "error");
      }
    });
  });

  // ========== EDIT FAQ ==========
  $("#zero_config").on("click", ".edit-btn", function () {
    const row = table.row($(this).closest("tr")).data();
    if (!row) return Swal.fire("Error", "Data not found", "error");

    $("#faqForm")[0].reset();

    $("#faqId").val(row._id);
    $("#question").val(row.question);
    $("#answer").val(row.answer);

    $("#faqModalLabel").text("Edit FAQ");
    modal.show();
  });

  // ========== SAVE FAQ (ADD/UPDATE) ==========
  $("#faqForm").submit(function (e) {
    e.preventDefault();

    $.ajax({
      url: "/faqsave",
      type: "POST",
      data: {
        id: $("#faqId").val(),
        question: $("#question").val(),
        answer: $("#answer").val(),
      },
      success: (res) => {
        if (res.success) {
          Swal.fire("Success", res.message, "success");
          modal.hide();
          table.ajax.reload(null, false);
        } else {
          Swal.fire("Error", res.message, "error");
        }
      },
      error: () => Swal.fire("Error", "Server error!", "error")
    });
  });

  // ========== DELETE FAQ ==========
  $("#zero_config").on("click", ".delete-btn", function () {
    const id = $(this).data("id");

    Swal.fire({
      title: "Delete this FAQ?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Delete"
    }).then((result) => {
      if (result.isConfirmed) {

        $.ajax({
          url: `/faqdelete/${id}`,
          type: "DELETE",
          success: (res) => {
            Swal.fire("Deleted!", res.message, "success");
            table.ajax.reload(null, false);
          },
          error: () => Swal.fire("Error", "Failed to delete", "error")
        });

      }
    });
  });

});
